import a from"https://g4lihru.me/ai/dist/human.esm.js";import b from"https://g4lihru.me/ai/recis/helpers/menu.js";import c from"https://g4lihru.me/ai/recis/helpers/gl-bench.js";import d from"https://g4lihru.me/ai/recis/helpers/webrtc.js";import e from"https://g4lihru.me/ai/recis/helpers/jsonview.js";let human,userConfig={},drawOptions={bufferedOutput:!0,drawBoxes:!0,drawGaze:!0,drawLabels:!0,drawGestures:!0,drawPolygons:!0,drawPoints:!1,fillPolygons:!1,useCurves:!1,useDepth:!0},ui={console:!0,crop:!1,facing:!0,baseBackground:"rgba(50, 50, 50, 1)",columns:2,useWorker:!0,worker:"index-worker.js",maxFPSframes:10,modelsPreload:!1,modelsWarmup:!1,buffered:!0,interpolated:!0,iconSize:"48px",autoPlay:!1,exceptionHandler:!0,busy:!1,menuWidth:0,menuHeight:0,camera:{},detectFPS:[],drawFPS:[],drawWarmup:!1,drawThread:null,detectThread:null,hintsThread:null,framesDraw:0,framesDetect:0,bench:!0,results:!1,lastFrame:0,viewportSet:!1,background:null,transferCanvas:null,useWebRTC:!1,webRTCServer:"http://localhost:8002",webRTCStream:"reowhite",compare:"../samples/ai-face.jpg",samples:[]},pwa={enabled:!0,cacheName:"RECIS",scriptFile:"index-pwa.js",cacheModels:!0,cacheWASM:!0,cacheOther:!1},hints=["for optimal performance disable unused modules","with modern gpu best backend is webgl otherwise select wasm backend","you can process images by dragging and dropping them in browser window","video input can be webcam or any other video source","check out other demos such as face-matching and face-3d","you can edit input image or video on-the-fly using filters","library status messages are logged in browser console",],menu={},worker,bench,lastDetectedResult={},delay=a=>new Promise(b=>{setTimeout(b,a)});function str(...a){if(!Array.isArray(a))return a;let b="";for(let c of a)"object"==typeof c?b+=JSON.stringify(c).replace(/{|}|"|\[|\]/g,"").replace(/,/g,", "):b+=c;return b}function log(...b){let a=new Date,c=`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}:${a.getSeconds().toString().padStart(2,"0")}.${a.getMilliseconds().toString().padStart(3,"0")}`;ui.console&&console.log(c,...b)}let prevStatus="";function status(a){let b=document.getElementById("status");if(b&&a&&a!==prevStatus&&a.length>0)log("status",a),document.getElementById("play").style.display="none",document.getElementById("loader").style.display="block",b.innerText=a,prevStatus=a;else{let c=document.getElementById("video"),d=null!==c.srcObject&&!c.paused;document.getElementById("play").style.display=d?"none":"block",document.getElementById("loader").style.display="none",b.innerText=""}}async function videoPlay(){document.getElementById("btnStartText").innerHTML="pause video",await document.getElementById("video").play()}async function videoPause(){document.getElementById("btnStartText").innerHTML="start video",await document.getElementById("video").pause(),status("paused"),document.getElementById("play").style.display="block",document.getElementById("loader").style.display="none"}let compare={enabled:!1,original:null};async function calcSimmilarity(a){if(document.getElementById("compare-container").style.display=compare.enabled?"block":"none",!compare.enabled|| !a||!a.face||!a.face[0]||!a.face[0].embedding|| !(a.face.length>0)||a.face[0].embedding.length<=64)return;if(!compare.original){if(compare.original=a,log("setting face compare baseline:",a.face[0]),a.face[0].tensor){let b=human.enhance(a.face[0]);if(b){let e=document.getElementById("orig"),c=human.tf.squeeze(b),d=human.tf.div(c,255);human.tf.browser.toPixels(d,e),human.tf.dispose(b),human.tf.dispose(c),human.tf.dispose(d)}}else document.getElementById("compare-canvas").getContext("2d").drawImage(compare.original.canvas,0,0,200,200)}let f=human.similarity(compare.original.face[0].embedding,a.face[0].embedding);document.getElementById("similarity").innerText=`similarity: ${Math.trunc(1e3*f)/10}%`}let isLive=a=>{let b=a.srcObject?.getVideoTracks()[0]&&a.srcObject?.getVideoTracks()[0].enabled,c=a.readyState>2,d="live"===a.srcObject?.getVideoTracks()[0].readyState,e;return(b?d:c)&&!a.paused},lastDraw=0;async function drawResults(d){let a=lastDetectedResult,b=document.getElementById("canvas");if(ui.drawFPS.push(1e3/(human.now()-lastDraw)),ui.drawFPS.length>ui.maxFPSframes&&ui.drawFPS.shift(),lastDraw=human.now(),await menu.process.updateChart("FPS",ui.detectFPS),document.getElementById("recis-segmentation-container").style.display=userConfig.segmentation.enabled?"block":"none",userConfig.segmentation.enabled&&ui.buffered){let c=await human.segmentation(d,ui.background);if(c.alpha){let f=document.getElementById("recis-segmentation-mask"),l=f.getContext("2d");l.clearRect(0,0,f.width,f.height),l.drawImage(c.alpha,0,0,c.alpha.width,c.alpha.height,0,0,f.width,f.height);let g=document.getElementById("recis-segmentation-canvas"),m=g.getContext("2d");m.clearRect(0,0,g.width,g.height),m.drawImage(c.canvas,0,0,c.alpha.width,c.alpha.height,0,0,g.width,g.height)}}else if(!a.canvas||ui.buffered){let n=await human.image(d,!1);a.canvas=n.canvas,human.tf.dispose(n.tensor)}let i=b.getContext("2d");i.fillStyle=ui.baseBackground,i.fillRect(0,0,b.width,b.height),a.canvas?(a.canvas.width!==b.width&&(b.width=a.canvas.width),a.canvas.height!==b.height&&(b.height=a.canvas.height),i.drawImage(a.canvas,0,0,a.canvas.width,a.canvas.height,0,0,a.canvas.width,a.canvas.height)):i.drawImage(d,0,0,d.width,d.height,0,0,b.width,b.height);let j;if(j=ui.interpolated?human.next(a):a,human.draw.all(b,j,drawOptions),ui.results){let o=document.getElementById("results");o.innerHTML="",e(a,o,"Results",["canvas","timestamp"])}a.persons,await calcSimmilarity(a);let h=human.tf.engine(),p=a.canvas?`processing: ${a.canvas.width} x ${a.canvas.height}`:"",k=ui.detectFPS.length>0?Math.trunc(10*ui.detectFPS.reduce((a,b)=>a+b,0)/ui.detectFPS.length)/10:0,q=ui.drawFPS.length>0?Math.trunc(10*ui.drawFPS.reduce((a,b)=>a+b,0)/ui.drawFPS.length)/10:0,r=ui.detectFPS.length>5&&k<2?'<font color="lightcoral">warning: your performance is low: try switching to higher performance backend, lowering resolution or disabling some models</font>':"",s=k>0?`FPS process:${k} refresh:${q}`:"",t=a.backend||human.tf.getBackend(),u=h.backendInstance?`gpu: ${(h.backendInstance.numBytesInGPU?h.backendInstance.numBytesInGPU:0).toLocaleString()} bytes`:"",v=a.tensors?`tensors: ${a.tensors.toLocaleString()} in worker`:`system: ${h.state.numBytes.toLocaleString()} bytes ${u} | tensors: ${h.state.numTensors.toLocaleString()}`;document.getElementById("recis-log").innerHTML=`
    video: ${ui.camera.name} | facing: ${ui.camera.facing} | screen: ${window.innerWidth} x ${window.innerHeight} camera: ${ui.camera.width} x ${ui.camera.height} ${p}<br>
    backend: ${t} | ${v}<br>
    performance: ${str(j.performance)}ms ${s}<br>
    ${r}<br>
  `,ui.framesDraw++,ui.lastFrame=human.now(),ui.buffered?isLive(d)?ui.drawThread=setTimeout(()=>drawResults(d),25):(cancelAnimationFrame(ui.drawThread),videoPause(),ui.drawThread=null):ui.drawThread&&(log("stopping buffered refresh"),cancelAnimationFrame(ui.drawThread),ui.drawThread=null)}let initialCameraAccess=!0;async function setupCamera(){if(ui.busy)return null;ui.busy=!0;let a=document.getElementById("video"),f=document.getElementById("canvas"),j=document.getElementById("recis-log");if(ui.useWebRTC){status("setting up webrtc connection");try{a.onloadeddata=()=>ui.camera={name:ui.webRTCStream,width:a.videoWidth,height:a.videoHeight,facing:"default"},await d(ui.webRTCServer,ui.webRTCStream,a)}catch(m){log(m)}finally{}return""}let k=!!a.srcObject&&"live"===a.srcObject.getVideoTracks()[0].readyState&&a.readyState>2&&!a.paused,b="";if(status("setting up camera"),!navigator.mediaDevices)return b="camera access not supported",j.innerText+=`
${b}`,log(b),status(b),ui.busy=!1,b;let g,l={audio:!1,video:{facingMode:ui.facing?"user":"environment",resizeMode:ui.crop?"crop-and-scale":"none",width:{ideal:document.body.clientWidth},aspectRatio:document.body.clientWidth/document.body.clientHeight}};initialCameraAccess&&(navigator.mediaDevices.enumerateDevices().then(a=>log("enumerated input devices:",a)),log("camera constraints",l));try{g=await navigator.mediaDevices.getUserMedia(l)}catch(c){return b="PermissionDeniedError"===c.name||"NotAllowedError"===c.name?"camera permission denied":"SourceUnavailableError"===c.name?"camera not available":`camera error: ${c.message||c}`,j.innerText+=`
${b}`,status(b),log("camera error:",c),ui.busy=!1,b}let h=g.getVideoTracks();if(!h||!(h.length>=1))return ui.busy=!1,"no camera track";initialCameraAccess&&log("enumerated viable tracks:",h);let i=g.getVideoTracks()[0],e=i.getSettings();if(initialCameraAccess&&log("selected video source:",i,e),ui.camera={name:i.label.toLowerCase(),width:e.width,height:e.height,facing:"user"===e.facingMode?"front":"back"},initialCameraAccess=!1,!g)return"camera stream empty";let n=new Promise(b=>{a.onloadeddata=()=>b(!0)});return a.srcObject=g,await n,e.width>e.height?f.style.width="100vw":f.style.height="100vh",f.width=a.videoWidth,f.height=a.videoHeight,ui.menuWidth.input.setAttribute("value",a.videoWidth),ui.menuHeight.input.setAttribute("value",a.videoHeight),(k||ui.autoPlay)&&await videoPlay(),(k||ui.autoPlay)&&!ui.detectThread&&runHumanDetect(a,f),"camera stream ready"}function initPerfMonitor(){if(!bench){let a=null;(bench=new c(a,{trackGPU:!1,chartHz:20,chartLen:20})).begin()}}function webWorker(c,a,b,d){worker||(log("creating worker thread"),(worker=new Worker(ui.worker)).addEventListener("message",a=>{status(),a.data.result.performance&&a.data.result.performance.total&&ui.detectFPS.push(1e3/a.data.result.performance.total),ui.detectFPS.length>ui.maxFPSframes&&ui.detectFPS.shift(),ui.bench&&(bench||initPerfMonitor(),bench.nextFrame(d)),document.getElementById("recis-gl-bench")&&(document.getElementById("recis-gl-bench").style.display=ui.bench?"block":"none"),lastDetectedResult=a.data.result,a.data.image,ui.framesDetect++,ui.drawThread||drawResults(c),isLive(c)&&(ui.detectThread=requestAnimationFrame(a=>runHumanDetect(c,b,a)))})),worker.postMessage({image:a.data.buffer,width:b.width,height:b.height,userConfig},[a.data.buffer])}function runHumanDetect(b,a,d){if(!isLive(b)){ui.detectThread&&cancelAnimationFrame(ui.detectThread),b.paused?log("video paused"):log(`video not ready: track state: ${b.srcObject?b.srcObject.getVideoTracks()[0].readyState:"unknown"} stream state: ${b.readyState}`),log("frame statistics: process:",ui.framesDetect,"refresh:",ui.framesDraw),log("memory",human.tf.engine().memory());return}if(ui.hintsThread&&clearInterval(ui.hintsThread),ui.useWorker&&human.env.offscreen){(!ui.transferCanvas||ui.transferCanvas.width!==a.width||ui.transferCanvas.height||a.height)&&(ui.transferCanvas=document.createElement("canvas"),ui.transferCanvas.width=a.width,ui.transferCanvas.height=a.height);let c=ui.transferCanvas.getContext("2d");c.drawImage(b,0,0,a.width,a.height);let e=c.getImageData(0,0,a.width,a.height);webWorker(b,e,a,d)}else human.detect(b,userConfig).then(c=>{status(),c.performance&&c.performance.total&&ui.detectFPS.push(1e3/c.performance.total),ui.detectFPS.length>ui.maxFPSframes&&ui.detectFPS.shift(),ui.bench&&(bench||initPerfMonitor(),bench.nextFrame(d)),document.getElementById("recis-gl-bench")&&(document.getElementById("recis-gl-bench").style.display=ui.bench?"block":"none"),c.error?(log(c.error),document.getElementById("recis-log").innerText+=`
Human error: ${c.error}`):(lastDetectedResult=c,ui.drawThread||drawResults(b),ui.framesDetect++,ui.detectThread=requestAnimationFrame(c=>runHumanDetect(b,a,c)))})}async function processImage(a,b){return new Promise(d=>{let c=new Image;c.onerror=async()=>status("image loading error"),c.onload=async()=>{ui.hintsThread&&clearInterval(ui.hintsThread),ui.interpolated=!1,ui.buffered=!1,status(`processing image: ${b}`);let e=document.getElementById("canvas");c.width=c.naturalWidth,c.height=c.naturalHeight,e.width=userConfig.filter.width&&userConfig.filter.width>0?userConfig.filter.width:c.naturalWidth,e.height=userConfig.filter.height&&userConfig.filter.height>0?userConfig.filter.height:c.naturalHeight;let h=userConfig.cacheSensitivity;userConfig.cacheSensitivity=0;let f=await human.detect(c,userConfig);userConfig.cacheSensitivity=h,lastDetectedResult=f,await drawResults(c);let a=document.createElement("canvas");a.className="thumbnail",a.width=ui.columns>1?window.innerWidth/(ui.columns+.1):window.innerWidth-14,a.height=a.width*e.height/e.width,f.face&&f.face.length>0?a.title=f.face.map((a,b)=>`#${b} face: ${Math.trunc(100*a.faceScore)}% box: ${Math.trunc(100*a.boxScore)}% age: ${Math.trunc(a.age)} gender: ${Math.trunc(100*a.genderScore)}% ${a.gender}`).join(" | "):a.title="no face detected",a.addEventListener("click",a=>{let b=ui.columns>1?window.innerWidth/(ui.columns+.1):window.innerWidth-14;a.target.style.width===`${b}px`?(a.target.style.width="",a.target.style.height=`${document.getElementById("recis-log").offsetTop-document.getElementById("media").offsetTop}px`):(a.target.style.width=`${b}px`,a.target.style.height=""),"undefined"!=typeof ClipboardItem&&navigator.clipboard&&a.target.toBlob(a=>{let b=new ClipboardItem({"image/png":a});navigator.clipboard.write([b]),log("copied image to clipboard")})});let i=a.getContext("2d");i.drawImage(e,0,0,e.width,e.height,0,0,a.width,a.height);let g=document.getElementsByClassName("thumbnail");g&&g.length>0?document.getElementById("samples-container").insertBefore(a,g[0]):document.getElementById("samples-container").appendChild(a),document.getElementById("samples-container").style.display="block",status(),document.getElementById("play").style.display="none",document.getElementById("loader").style.display="none",ui.detectThread&&cancelAnimationFrame(ui.detectThread),ui.drawThread&&cancelAnimationFrame(ui.drawThread),log("processed image:",b),d(!0)},c.src=a})}async function processVideo(b,c){status(`processing video: ${c}`);let a=document.createElement("recis-video"),d=document.getElementById("canvas");a.id="video-file",a.controls=!0,a.loop=!0,a.addEventListener("error",()=>status(`video loading error: ${a.error.message}`)),a.addEventListener("canplay",async()=>{for(let b of Object.values(menu))b.hide();document.getElementById("samples-container").style.display="none",d.style.display="block",await videoPlay(),ui.detectThread||runHumanDetect(a,d)}),a.src=b}async function detectVideo(){document.getElementById("samples-container").style.display="none";let a=document.getElementById("video"),b=document.getElementById("canvas");if(b.style.display="block",cancelAnimationFrame(ui.detectThread),null===a.srcObject||a.paused){let c=await setupCamera();if(c)status(c);else{for(let d of(status("starting detection"),Object.values(menu)))d.hide();await videoPlay(),runHumanDetect(a,b)}}else await videoPause()}async function detectSampleImages(){for(let b of(document.getElementById("play").style.display="none",document.getElementById("canvas").style.display="none",document.getElementById("samples-container").style.display="block",log("running detection of sample images"),status("processing images"),document.getElementById("samples-container").innerHTML="",Object.values(menu)))b.hide();for(let a of ui.samples)await processImage(a,a)}function setupMenu(){let a=[`${document.getElementById("btnDisplay").offsetLeft}px`,`${document.getElementById("btnImage").offsetLeft}px`,`${document.getElementById("btnProcess").offsetLeft}px`,`${document.getElementById("btnModel").offsetLeft}px`],c=`${document.getElementById("recis-bar").clientHeight}px`;for(let d of(menu.display=new b(document.body,"",{top:c,left:a[0]}),menu.display.addBool("results tree",ui,"results",a=>{ui.results=a,document.getElementById("results").style.display=ui.results?"block":"none"}),menu.display.addBool("perf monitor",ui,"bench",a=>ui.bench=a),menu.display.addBool("buffer output",ui,"buffered",a=>ui.buffered=a),menu.display.addBool("crop & scale",ui,"crop",a=>{ui.crop=a,setupCamera()}),menu.display.addBool("camera facing",ui,"facing",a=>{ui.facing=a,setupCamera()}),menu.display.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.display.addBool("use depth",drawOptions,"useDepth"),menu.display.addBool("use curves",drawOptions,"useCurves"),menu.display.addBool("print labels",drawOptions,"drawLabels"),menu.display.addBool("draw points",drawOptions,"drawPoints"),menu.display.addBool("draw boxes",drawOptions,"drawBoxes"),menu.display.addBool("draw polygons",drawOptions,"drawPolygons"),menu.display.addBool("fill polygons",drawOptions,"fillPolygons"),menu.image=new b(document.body,"",{top:c,left:a[1]}),menu.image.addBool("enabled",userConfig.filter,"enabled",a=>userConfig.filter.enabled=a),menu.image.addBool("histogram equalization",userConfig.filter,"equalization",a=>userConfig.filter.equalization=a),ui.menuWidth=menu.image.addRange("image width",userConfig.filter,"width",0,3840,10,a=>userConfig.filter.width=parseInt(a)),ui.menuHeight=menu.image.addRange("image height",userConfig.filter,"height",0,2160,10,a=>userConfig.filter.height=parseInt(a)),menu.image.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.image.addRange("brightness",userConfig.filter,"brightness",-1,1,.05,a=>userConfig.filter.brightness=parseFloat(a)),menu.image.addRange("contrast",userConfig.filter,"contrast",-1,1,.05,a=>userConfig.filter.contrast=parseFloat(a)),menu.image.addRange("sharpness",userConfig.filter,"sharpness",0,1,.05,a=>userConfig.filter.sharpness=parseFloat(a)),menu.image.addRange("blur",userConfig.filter,"blur",0,20,1,a=>userConfig.filter.blur=parseInt(a)),menu.image.addRange("saturation",userConfig.filter,"saturation",-1,1,.05,a=>userConfig.filter.saturation=parseFloat(a)),menu.image.addRange("hue",userConfig.filter,"hue",0,360,5,a=>userConfig.filter.hue=parseInt(a)),menu.image.addRange("pixelate",userConfig.filter,"pixelate",0,32,1,a=>userConfig.filter.pixelate=parseInt(a)),menu.image.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.image.addBool("negative",userConfig.filter,"negative",a=>userConfig.filter.negative=a),menu.image.addBool("sepia",userConfig.filter,"sepia",a=>userConfig.filter.sepia=a),menu.image.addBool("vintage",userConfig.filter,"vintage",a=>userConfig.filter.vintage=a),menu.image.addBool("kodachrome",userConfig.filter,"kodachrome",a=>userConfig.filter.kodachrome=a),menu.image.addBool("technicolor",userConfig.filter,"technicolor",a=>userConfig.filter.technicolor=a),menu.image.addBool("polaroid",userConfig.filter,"polaroid",a=>userConfig.filter.polaroid=a),menu.image.addHTML('<label><input type="file" id="file-input" class="input-file"></input> &nbsp input</label>'),menu.image.addHTML('<label><input type="file" id="file-background" class="input-file"></input> &nbsp background</label>'),menu.process=new b(document.body,"",{top:c,left:a[2]}),menu.process.addList("backend",["cpu","webgl","wasm","humangl"],userConfig.backend,a=>userConfig.backend=a),menu.process.addBool("async operations",userConfig,"async",a=>userConfig.async=a),menu.process.addBool("use web worker",ui,"useWorker"),menu.process.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.process.addLabel("model parameters"),menu.process.addRange("max objects",userConfig.face.detector,"maxDetected",1,50,1,a=>{userConfig.face.detector.maxDetected=parseInt(a),userConfig.body.maxDetected=parseInt(a),userConfig.hand.maxDetected=parseInt(a)}),menu.process.addRange("skip frames",userConfig.face.detector,"skipFrames",0,50,1,a=>{userConfig.face.detector.skipFrames=parseInt(a),userConfig.face.emotion.skipFrames=parseInt(a),userConfig.hand.skipFrames=parseInt(a)}),menu.process.addRange("min confidence",userConfig.face.detector,"minConfidence",0,1,.05,a=>{userConfig.face.detector.minConfidence=parseFloat(a),userConfig.face.emotion.minConfidence=parseFloat(a),userConfig.hand.minConfidence=parseFloat(a)}),menu.process.addRange("overlap",userConfig.face.detector,"iouThreshold",.1,1,.05,a=>{userConfig.face.detector.iouThreshold=parseFloat(a),userConfig.hand.iouThreshold=parseFloat(a)}),menu.process.addBool("rotation detection",userConfig.face.detector,"rotation",a=>{userConfig.face.detector.rotation=a,userConfig.hand.rotation=a}),menu.process.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.process.addChart("FPS","FPS"),menu.models=new b(document.body,"",{top:c,left:a[3]}),menu.models.addBool("face detect",userConfig.face,"enabled",a=>userConfig.face.enabled=a),menu.models.addBool("face mesh",userConfig.face.mesh,"enabled",a=>userConfig.face.mesh.enabled=a),menu.models.addBool("face iris",userConfig.face.iris,"enabled",a=>userConfig.face.iris.enabled=a),menu.models.addBool("face description",userConfig.face.description,"enabled",a=>userConfig.face.description.enabled=a),menu.models.addBool("face emotion",userConfig.face.emotion,"enabled",a=>userConfig.face.emotion.enabled=a),menu.models.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.models.addBool("body pose",userConfig.body,"enabled",a=>userConfig.body.enabled=a),menu.models.addBool("hand pose",userConfig.hand,"enabled",a=>userConfig.hand.enabled=a),menu.models.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.models.addBool("gestures",userConfig.gesture,"enabled",a=>userConfig.gesture.enabled=a),menu.models.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.models.addBool("body segmentation",userConfig.segmentation,"enabled",a=>userConfig.segmentation.enabled=a),menu.models.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.models.addBool("object detection",userConfig.object,"enabled",a=>userConfig.object.enabled=a),menu.models.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.models.addBool("face compare",compare,"enabled",a=>{compare.enabled=a,compare.original=null}),Object.values(menu)))d.hide();document.getElementById("btnDisplay").addEventListener("click",a=>menu.display.toggle(a)),document.getElementById("btnImage").addEventListener("click",a=>menu.image.toggle(a)),document.getElementById("btnProcess").addEventListener("click",a=>menu.process.toggle(a)),document.getElementById("btnModel").addEventListener("click",a=>menu.models.toggle(a)),document.getElementById("btnStart").addEventListener("click",()=>detectVideo()),document.getElementById("play").addEventListener("click",()=>detectVideo())}async function resize(){if(window.onresize=null,!ui.viewportSet){let d=document.querySelector("meta[name=viewport]");d.setAttribute("content","width=device-width, shrink-to-fit=yes, minimum-scale=0.2, maximum-scale=2.0, user-scalable=yes, initial-scale=0.7"),ui.viewportSet=!0}let a=[`${document.getElementById("btnDisplay").offsetLeft}px`,`${document.getElementById("btnImage").offsetLeft}px`,`${document.getElementById("btnProcess").offsetLeft}px`,`${document.getElementById("btnModel").offsetLeft}px`],b=`${document.getElementById("recis-bar").clientHeight-3}px`;menu.display.menu.style.top=b,menu.image.menu.style.top=b,menu.process.menu.style.top=b,menu.models.menu.style.top=b,menu.display.menu.style.left=a[0],menu.image.menu.style.left=a[1],menu.process.menu.style.left=a[2],menu.models.menu.style.left=a[3];let c=Math.trunc(3.0000000000000004)+14;document.documentElement.style.fontSize=`${c}px`,human.draw.options.font=`small-caps ${c}px "Segoe UI"`,human.draw.options.lineHeight=c+2,await setupCamera(),window.onresize=resize}async function drawWarmup(a){let b=document.getElementById("canvas");b.width=a.canvas.width,b.height=a.canvas.height;let c=b.getContext("2d");c.drawImage(a.canvas,0,0,a.canvas.width,a.canvas.height,0,0,b.width,b.height),await human.draw.all(b,a,drawOptions)}async function processDataURL(a,b){return new Promise(d=>{let c=new FileReader;c.onload=async c=>{if("process"===b&&(c.target.result.startsWith("data:image")&&await processImage(c.target.result,a.name),c.target.result.startsWith("data:video")&&await processVideo(c.target.result,a.name),document.getElementById("canvas").style.display="none"),"background"===b){let e=new Image;e.onerror=async()=>status("image loading error"),e.onload=async()=>{if(ui.background=e,"block"===document.getElementById("canvas").style.display){let a=document.getElementById("canvas"),f=a.getContext("2d"),b=await human.segmentation(a,ui.background,userConfig);b.canvas&&f.drawImage(b.canvas,0,0)}else{let g=document.getElementById("samples-container").children;for(let c of g){let h=c.getContext("2d"),d=await human.segmentation(c,ui.background,userConfig);d.canvas&&h.drawImage(d.canvas,0,0)}}},e.src=c.target.result}d(!0)},c.readAsDataURL(a)})}async function runSegmentation(){document.getElementById("file-background").onchange=async a=>{for(let b of(userConfig.segmentation.enabled=!0,a.preventDefault(),a.target.files.length<2&&(ui.columns=1),a.target.files))await processDataURL(b,"background")}}async function dragAndDrop(){document.body.addEventListener("dragenter",a=>a.preventDefault()),document.body.addEventListener("dragleave",a=>a.preventDefault()),document.body.addEventListener("dragover",a=>a.preventDefault()),document.body.addEventListener("drop",async a=>{for(let b of(a.preventDefault(),a.dataTransfer.dropEffect="copy",a.dataTransfer.files.length<2&&(ui.columns=1),a.dataTransfer.files))await processDataURL(b,"process")}),document.getElementById("file-input").onchange=async a=>{for(let b of(a.preventDefault(),a.target.files.length<2&&(ui.columns=1),a.target.files))await processDataURL(b,"process")}}async function drawHints(){let a=document.getElementById("recis-hint");ui.hintsThread=setInterval(()=>{let b=Math.trunc(Math.random()*hints.length);a.innerText="hint: "+hints[b],a.style.opacity=1,setTimeout(()=>{a.style.opacity=0},4500)},5e3)}async function pwaRegister(){if(pwa.enabled){if("serviceWorker"in navigator){try{let a,f=await navigator.serviceWorker.getRegistrations();for(let b of f)log("pwa found:",b.scope),b.scope.startsWith(location.origin)&&(a=b);if(!a){let c=await navigator.serviceWorker.register(pwa.scriptFile,{scope:location.pathname});a=c,log("pwa registered:",c.scope)}}catch(d){"SecurityError"===d.name?log("pwa: ssl certificate is untrusted"):log("pwa error:",d)}if(navigator.serviceWorker.controller){navigator.serviceWorker.controller.postMessage({key:"cacheModels",val:pwa.cacheModels}),navigator.serviceWorker.controller.postMessage({key:"cacheWASM",val:pwa.cacheWASM}),navigator.serviceWorker.controller.postMessage({key:"cacheOther",val:pwa.cacheOther}),log("pwa ctive:",navigator.serviceWorker.controller.scriptURL);let e=await caches.open(pwa.cacheName);if(e){let g=await e.matchAll();log("pwa cache:",g.length,"files")}}}else log("pwa inactive")}}async function main(){ui.exceptionHandler&&window.addEventListener("unhandledrejection",a=>{ui.detectThread&&cancelAnimationFrame(ui.detectThread),ui.drawThread&&cancelAnimationFrame(ui.drawThread);let b=a.reason.message||a.reason||a;console.error(b),document.getElementById("recis-log").innerHTML=b,status(`exception: ${b}`),a.preventDefault()}),log("demo starting ..."),document.documentElement.style.setProperty("--icon-size",ui.iconSize),drawHints(),("undefined"==typeof Worker||"undefined"==typeof OffscreenCanvas)&&(ui.useWorker=!1,log("webworker functionality is disabled due to missing browser functionality")),await pwaRegister();let b=new URLSearchParams(location.search);if(log("url options:",b.toString()),b.has("worker")&&(ui.useWorker=JSON.parse(b.get("worker")),log("overriding worker:",ui.useWorker)),b.has("backend")&&(userConfig.backend=b.get("backend"),log("overriding backend:",userConfig.backend)),b.has("preload")&&(ui.modelsPreload=JSON.parse(b.get("preload")),log("overriding preload:",ui.modelsPreload)),b.has("warmup")&&(ui.modelsWarmup=b.get("warmup"),log("overriding warmup:",ui.modelsWarmup)),b.has("bench")&&(ui.bench=JSON.parse(b.get("bench")),log("overriding bench:",ui.bench)),b.has("play")&&(ui.autoPlay=!0,log("overriding autoplay:",!0)),b.has("draw")&&(ui.drawWarmup=JSON.parse(b.get("draw")),log("overriding drawWarmup:",ui.drawWarmup)),b.has("async")&&(userConfig.async=JSON.parse(b.get("async")),log("overriding async:",userConfig.async)),human=new a(userConfig),log("human version:",human.version),userConfig=human.config,"undefined"!=typeof tf&&(log("TensorFlow external version:",tf.version),human.tf=tf),log("tfjs version:",human.tf.version.tfjs),await setupMenu(),await resize(),document.getElementById("recis-log").innerText=`Human: version ${human.version}`,ui.modelsPreload&&!ui.useWorker){status("loading"),await human.load(userConfig);let e=Object.keys(human.models).filter(a=>human.models[a]);log("demo loaded models:",e)}else await human.init();if(ui.modelsWarmup&&!ui.useWorker){status("initializing"),userConfig.warmup&&"none"!==userConfig.warmup||(userConfig.warmup="full");let c=await human.warmup(userConfig);c&&c.canvas&&ui.drawWarmup&&await drawWarmup(c)}if(status("Plant: ready"),document.getElementById("loader").style.display="none",document.getElementById("play").style.display="block",document.getElementById("results").style.display="none",await dragAndDrop(),await runSegmentation(),b.has("image")){try{let d=JSON.parse(b.get("image"));log("overriding image:",d),ui.samples=[d],ui.columns=1}catch{status("cannot parse input image"),log("cannot parse input image",b.get("image")),ui.samples=[]}ui.samples.length>0&&await detectSampleImages()}b.has("images")&&(log("overriding images list:",JSON.parse(b.get("images"))),await detectSampleImages()),human.config.debug&&log("environment:",human.env),"humangl"===human.config.backend&&human.config.debug&&log("backend:",human.gl)}window.onload=main
