import Human from"https://g4lihru.me/ai/dist/human.esm.js";import Menu from"https://g4lihru.me/ai/recis/helpers/menu.js";import GLBench from"https://g4lihru.me/ai/recis/helpers/gl-bench.js";import webRTC from"https://g4lihru.me/ai/recis/helpers/webrtc.js";import jsonView from"https://g4lihru.me/ai/recis/helpers/jsonview.js";let human,userConfig={};const drawOptions={bufferedOutput:!0,drawBoxes:!0,drawGaze:!0,drawLabels:!0,drawGestures:!0,drawPolygons:!0,drawPoints:!1,fillPolygons:!1,useCurves:!1,useDepth:!0},ui={console:!0,crop:!1,facing:!0,baseBackground:"rgba(50, 50, 50, 1)",columns:2,useWorker:!0,worker:"index-worker.js",maxFPSframes:10,modelsPreload:!1,modelsWarmup:!1,buffered:!0,interpolated:!0,iconSize:"48px",autoPlay:!1,exceptionHandler:!0,busy:!1,menuWidth:0,menuHeight:0,camera:{},detectFPS:[],drawFPS:[],drawWarmup:!1,drawThread:null,detectThread:null,hintsThread:null,framesDraw:0,framesDetect:0,bench:!0,results:!1,lastFrame:0,viewportSet:!1,background:null,transferCanvas:null,useWebRTC:!1,webRTCServer:"http://localhost:8002",webRTCStream:"reowhite",compare:"../samples/ai-face.jpg",samples:[]},pwa={enabled:!0,cacheName:"RECIS",scriptFile:"index-pwa.js",cacheModels:!0,cacheWASM:!0,cacheOther:!1},hints=["for optimal performance disable unused modules","with modern gpu best backend is webgl otherwise select wasm backend","you can process images by dragging and dropping them in browser window","video input can be webcam or any other video source","check out other demos such as face-matching and face-3d","you can edit input image or video on-the-fly using filters","library status messages are logged in browser console"],menu={};let worker,bench,lastDetectedResult={};const delay=e=>new Promise((t=>{setTimeout(t,e)}));function str(...e){if(!Array.isArray(e))return e;let t="";for(const a of e)t+="object"==typeof a?JSON.stringify(a).replace(/{|}|"|\[|\]/g,"").replace(/,/g,", "):a;return t}function log(...e){const t=new Date,a=`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")}.${t.getMilliseconds().toString().padStart(3,"0")}`;ui.console&&console.log(a,...e)}let prevStatus="";function status(e){const t=document.getElementById("status");if(t&&e&&e!==prevStatus&&e.length>0)log("status",e),document.getElementById("play").style.display="none",document.getElementById("loader").style.display="block",t.innerText=e,prevStatus=e;else{const e=document.getElementById("video"),a=null!==e.srcObject&&!e.paused;document.getElementById("play").style.display=a?"none":"block",document.getElementById("loader").style.display="none",t.innerText=""}}async function videoPlay(){document.getElementById("btnStartText").innerHTML="pause video",await document.getElementById("video").play()}async function videoPause(){document.getElementById("btnStartText").innerHTML="start video",await document.getElementById("video").pause(),status("paused"),document.getElementById("play").style.display="block",document.getElementById("loader").style.display="none"}const compare={enabled:!1,original:null};async function calcSimmilarity(e){if(document.getElementById("compare-container").style.display=compare.enabled?"block":"none",!compare.enabled)return;if(!(e&&e.face&&e.face[0]&&e.face[0].embedding))return;if(!(e.face.length>0)||e.face[0].embedding.length<=64)return;if(!compare.original)if(compare.original=e,log("setting face compare baseline:",e.face[0]),e.face[0].tensor){const t=human.enhance(e.face[0]);if(t){const e=document.getElementById("orig"),a=human.tf.squeeze(t),n=human.tf.div(a,255);human.tf.browser.toPixels(n,e),human.tf.dispose(t),human.tf.dispose(a),human.tf.dispose(n)}}else document.getElementById("compare-canvas").getContext("2d").drawImage(compare.original.canvas,0,0,200,200);const t=human.similarity(compare.original.face[0].embedding,e.face[0].embedding);document.getElementById("similarity").innerText=`similarity: ${Math.trunc(1e3*t)/10}%`}const isLive=e=>{const t=e.srcObject?.getVideoTracks()[0]&&e.srcObject?.getVideoTracks()[0].enabled,a=e.readyState>2,n="live"===e.srcObject?.getVideoTracks()[0].readyState;let i=t?n:a;return i=i&&!e.paused,i};let lastDraw=0;async function drawResults(e){const t=lastDetectedResult,a=document.getElementById("canvas");if(ui.drawFPS.push(1e3/(human.now()-lastDraw)),ui.drawFPS.length>ui.maxFPSframes&&ui.drawFPS.shift(),lastDraw=human.now(),await menu.process.updateChart("FPS",ui.detectFPS),document.getElementById("recis-segmentation-container").style.display=userConfig.segmentation.enabled?"block":"none",userConfig.segmentation.enabled&&ui.buffered){const t=await human.segmentation(e,ui.background);if(t.alpha){const e=document.getElementById("recis-segmentation-mask"),a=e.getContext("2d");a.clearRect(0,0,e.width,e.height),a.drawImage(t.alpha,0,0,t.alpha.width,t.alpha.height,0,0,e.width,e.height);const n=document.getElementById("recis-segmentation-canvas"),i=n.getContext("2d");i.clearRect(0,0,n.width,n.height),i.drawImage(t.canvas,0,0,t.alpha.width,t.alpha.height,0,0,n.width,n.height)}}else if(!t.canvas||ui.buffered){const a=await human.image(e,!1);t.canvas=a.canvas,human.tf.dispose(a.tensor)}const n=a.getContext("2d");let i;if(n.fillStyle=ui.baseBackground,n.fillRect(0,0,a.width,a.height),t.canvas?(t.canvas.width!==a.width&&(a.width=t.canvas.width),t.canvas.height!==a.height&&(a.height=t.canvas.height),n.drawImage(t.canvas,0,0,t.canvas.width,t.canvas.height,0,0,t.canvas.width,t.canvas.height)):n.drawImage(e,0,0,e.width,e.height,0,0,a.width,a.height),i=ui.interpolated?human.next(t):t,human.draw.all(a,i,drawOptions),ui.results){const e=document.getElementById("results");e.innerHTML="",jsonView(t,e,"Results",["canvas","timestamp"])}t.persons;await calcSimmilarity(t);const o=human.tf.engine(),r=t.canvas?`processing: ${t.canvas.width} x ${t.canvas.height}`:"",s=ui.detectFPS.length>0?Math.trunc(10*ui.detectFPS.reduce(((e,t)=>e+t),0)/ui.detectFPS.length)/10:0,d=ui.drawFPS.length>0?Math.trunc(10*ui.drawFPS.reduce(((e,t)=>e+t),0)/ui.drawFPS.length)/10:0,c=ui.detectFPS.length>5&&s<2?'<font color="lightcoral">warning: your performance is low: try switching to higher performance backend, lowering resolution or disabling some models</font>':"",l=s>0?`FPS process:${s} refresh:${d}`:"",u=t.backend||human.tf.getBackend(),m=o.backendInstance?`gpu: ${(o.backendInstance.numBytesInGPU?o.backendInstance.numBytesInGPU:0).toLocaleString()} bytes`:"",g=t.tensors?`tensors: ${t.tensors.toLocaleString()} in worker`:`system: ${o.state.numBytes.toLocaleString()} bytes ${m} | tensors: ${o.state.numTensors.toLocaleString()}`;document.getElementById("recis-log").innerHTML=`\n    video: ${ui.camera.name} | facing: ${ui.camera.facing} | screen: ${window.innerWidth} x ${window.innerHeight} camera: ${ui.camera.width} x ${ui.camera.height} ${r}<br>\n    backend: ${u} | ${g}<br>\n    performance: ${str(i.performance)}ms ${l}<br>\n    ${c}<br>\n  `,ui.framesDraw++,ui.lastFrame=human.now(),ui.buffered?isLive(e)?ui.drawThread=setTimeout((()=>drawResults(e)),25):(cancelAnimationFrame(ui.drawThread),videoPause(),ui.drawThread=null):ui.drawThread&&(log("stopping buffered refresh"),cancelAnimationFrame(ui.drawThread),ui.drawThread=null)}let initialCameraAccess=!0;async function setupCamera(){if(ui.busy)return null;ui.busy=!0;const e=document.getElementById("video"),t=document.getElementById("canvas"),a=document.getElementById("recis-log");if(ui.useWebRTC){status("setting up webrtc connection");try{e.onloadeddata=()=>ui.camera={name:ui.webRTCStream,width:e.videoWidth,height:e.videoHeight,facing:"default"},await webRTC(ui.webRTCServer,ui.webRTCStream,e)}catch(e){log(e)}return""}const n=!!e.srcObject&&("live"===e.srcObject.getVideoTracks()[0].readyState&&e.readyState>2&&!e.paused);let i,o="";if(status("setting up camera"),!navigator.mediaDevices)return o="camera access not supported",a.innerText+=`\n${o}`,log(o),status(o),ui.busy=!1,o;const r={audio:!1,video:{facingMode:ui.facing?"user":"environment",resizeMode:ui.crop?"crop-and-scale":"none",width:{ideal:document.body.clientWidth},aspectRatio:document.body.clientWidth/document.body.clientHeight}};initialCameraAccess&&(navigator.mediaDevices.enumerateDevices().then((e=>log("enumerated input devices:",e))),log("camera constraints",r));try{i=await navigator.mediaDevices.getUserMedia(r)}catch(e){return o="PermissionDeniedError"===e.name||"NotAllowedError"===e.name?"camera permission denied":"SourceUnavailableError"===e.name?"camera not available":`camera error: ${e.message||e}`,a.innerText+=`\n${o}`,status(o),log("camera error:",e),ui.busy=!1,o}const s=i.getVideoTracks();if(!(s&&s.length>=1))return ui.busy=!1,"no camera track";initialCameraAccess&&log("enumerated viable tracks:",s);const d=i.getVideoTracks()[0],c=d.getSettings();if(initialCameraAccess&&log("selected video source:",d,c),ui.camera={name:d.label.toLowerCase(),width:c.width,height:c.height,facing:"user"===c.facingMode?"front":"back"},initialCameraAccess=!1,!i)return"camera stream empty";const l=new Promise((t=>{e.onloadeddata=()=>t(!0)}));return e.srcObject=i,await l,c.width>c.height?t.style.width="100vw":t.style.height="100vh",t.width=e.videoWidth,t.height=e.videoHeight,ui.menuWidth.input.setAttribute("value",e.videoWidth),ui.menuHeight.input.setAttribute("value",e.videoHeight),(n||ui.autoPlay)&&await videoPlay(),!n&&!ui.autoPlay||ui.detectThread||runHumanDetect(e,t),"camera stream ready"}function initPerfMonitor(){if(!bench){bench=new GLBench(null,{trackGPU:!1,chartHz:20,chartLen:20}),bench.begin()}}function webWorker(e,t,a,n){worker||(log("creating worker thread"),worker=new Worker(ui.worker),worker.addEventListener("message",(t=>{status(),t.data.result.performance&&t.data.result.performance.total&&ui.detectFPS.push(1e3/t.data.result.performance.total),ui.detectFPS.length>ui.maxFPSframes&&ui.detectFPS.shift(),ui.bench&&(bench||initPerfMonitor(),bench.nextFrame(n)),document.getElementById("recis-gl-bench")&&(document.getElementById("recis-gl-bench").style.display=ui.bench?"block":"none"),lastDetectedResult=t.data.result,t.data.image,ui.framesDetect++,ui.drawThread||drawResults(e),isLive(e)&&(ui.detectThread=requestAnimationFrame((t=>runHumanDetect(e,a,t))))}))),worker.postMessage({image:t.data.buffer,width:a.width,height:a.height,userConfig:userConfig},[t.data.buffer])}function runHumanDetect(e,t,a){if(!isLive(e))return ui.detectThread&&cancelAnimationFrame(ui.detectThread),e.paused?log("video paused"):log(`video not ready: track state: ${e.srcObject?e.srcObject.getVideoTracks()[0].readyState:"unknown"} stream state: ${e.readyState}`),log("frame statistics: process:",ui.framesDetect,"refresh:",ui.framesDraw),void log("memory",human.tf.engine().memory());if(ui.hintsThread&&clearInterval(ui.hintsThread),ui.useWorker&&human.env.offscreen){(!ui.transferCanvas||ui.transferCanvas.width!==t.width||ui.transferCanvas.height||t.height)&&(ui.transferCanvas=document.createElement("canvas"),ui.transferCanvas.width=t.width,ui.transferCanvas.height=t.height);const n=ui.transferCanvas.getContext("2d");n.drawImage(e,0,0,t.width,t.height);const i=n.getImageData(0,0,t.width,t.height);webWorker(e,i,t,a)}else human.detect(e,userConfig).then((n=>{status(),n.performance&&n.performance.total&&ui.detectFPS.push(1e3/n.performance.total),ui.detectFPS.length>ui.maxFPSframes&&ui.detectFPS.shift(),ui.bench&&(bench||initPerfMonitor(),bench.nextFrame(a)),document.getElementById("recis-gl-bench")&&(document.getElementById("recis-gl-bench").style.display=ui.bench?"block":"none"),n.error?(log(n.error),document.getElementById("recis-log").innerText+=`\nHuman error: ${n.error}`):(lastDetectedResult=n,ui.drawThread||drawResults(e),ui.framesDetect++,ui.detectThread=requestAnimationFrame((a=>runHumanDetect(e,t,a))))}))}async function processImage(e,t){return new Promise((a=>{const n=new Image;n.onerror=async()=>status("image loading error"),n.onload=async()=>{ui.hintsThread&&clearInterval(ui.hintsThread),ui.interpolated=!1,ui.buffered=!1,status(`processing image: ${t}`);const e=document.getElementById("canvas");n.width=n.naturalWidth,n.height=n.naturalHeight,e.width=userConfig.filter.width&&userConfig.filter.width>0?userConfig.filter.width:n.naturalWidth,e.height=userConfig.filter.height&&userConfig.filter.height>0?userConfig.filter.height:n.naturalHeight;const i=userConfig.cacheSensitivity;userConfig.cacheSensitivity=0;const o=await human.detect(n,userConfig);userConfig.cacheSensitivity=i,lastDetectedResult=o,await drawResults(n);const r=document.createElement("canvas");r.className="thumbnail",r.width=ui.columns>1?window.innerWidth/(ui.columns+.1):window.innerWidth-14,r.height=r.width*e.height/e.width,o.face&&o.face.length>0?r.title=o.face.map(((e,t)=>`#${t} face: ${Math.trunc(100*e.faceScore)}% box: ${Math.trunc(100*e.boxScore)}% age: ${Math.trunc(e.age)} gender: ${Math.trunc(100*e.genderScore)}% ${e.gender}`)).join(" | "):r.title="no face detected",r.addEventListener("click",(e=>{const t=ui.columns>1?window.innerWidth/(ui.columns+.1):window.innerWidth-14;e.target.style.width===`${t}px`?(e.target.style.width="",e.target.style.height=document.getElementById("recis-log").offsetTop-document.getElementById("media").offsetTop+"px"):(e.target.style.width=`${t}px`,e.target.style.height=""),"undefined"!=typeof ClipboardItem&&navigator.clipboard&&e.target.toBlob((e=>{const t=new ClipboardItem({"image/png":e});navigator.clipboard.write([t]),log("copied image to clipboard")}))}));r.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,r.width,r.height);const s=document.getElementsByClassName("thumbnail");s&&s.length>0?document.getElementById("samples-container").insertBefore(r,s[0]):document.getElementById("samples-container").appendChild(r),document.getElementById("samples-container").style.display="block",status(),document.getElementById("play").style.display="none",document.getElementById("loader").style.display="none",ui.detectThread&&cancelAnimationFrame(ui.detectThread),ui.drawThread&&cancelAnimationFrame(ui.drawThread),log("processed image:",t),a(!0)},n.src=e}))}async function processVideo(e,t){status(`processing video: ${t}`);const a=document.createElement("recis-video"),n=document.getElementById("canvas");a.id="video-file",a.controls=!0,a.loop=!0,a.addEventListener("error",(()=>status(`video loading error: ${a.error.message}`))),a.addEventListener("canplay",(async()=>{for(const e of Object.values(menu))e.hide();document.getElementById("samples-container").style.display="none",n.style.display="block",await videoPlay(),ui.detectThread||runHumanDetect(a,n)})),a.src=e}async function detectVideo(){document.getElementById("samples-container").style.display="none";const e=document.getElementById("video"),t=document.getElementById("canvas");if(t.style.display="block",cancelAnimationFrame(ui.detectThread),null===e.srcObject||e.paused){const a=await setupCamera();if(a)status(a);else{status("starting detection");for(const e of Object.values(menu))e.hide();await videoPlay(),runHumanDetect(e,t)}}else await videoPause()}async function detectSampleImages(){document.getElementById("play").style.display="none",document.getElementById("canvas").style.display="none",document.getElementById("samples-container").style.display="block",log("running detection of sample images"),status("processing images"),document.getElementById("samples-container").innerHTML="";for(const e of Object.values(menu))e.hide();for(const e of ui.samples)await processImage(e,e)}function setupMenu(){const e=[`${document.getElementById("btnDisplay").offsetLeft}px`,`${document.getElementById("btnImage").offsetLeft}px`,`${document.getElementById("btnProcess").offsetLeft}px`,`${document.getElementById("btnModel").offsetLeft}px`],t=`${document.getElementById("recis-bar").clientHeight}px`;menu.display=new Menu(document.body,"",{top:t,left:e[0]}),menu.display.addBool("results tree",ui,"results",(e=>{ui.results=e,document.getElementById("results").style.display=ui.results?"block":"none"})),menu.display.addBool("perf monitor",ui,"bench",(e=>ui.bench=e)),menu.display.addBool("buffer output",ui,"buffered",(e=>ui.buffered=e)),menu.display.addBool("crop & scale",ui,"crop",(e=>{ui.crop=e,setupCamera()})),menu.display.addBool("camera facing",ui,"facing",(e=>{ui.facing=e,setupCamera()})),menu.display.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.display.addBool("use depth",drawOptions,"useDepth"),menu.display.addBool("use curves",drawOptions,"useCurves"),menu.display.addBool("print labels",drawOptions,"drawLabels"),menu.display.addBool("draw points",drawOptions,"drawPoints"),menu.display.addBool("draw boxes",drawOptions,"drawBoxes"),menu.display.addBool("draw polygons",drawOptions,"drawPolygons"),menu.display.addBool("fill polygons",drawOptions,"fillPolygons"),menu.image=new Menu(document.body,"",{top:t,left:e[1]}),menu.image.addBool("enabled",userConfig.filter,"enabled",(e=>userConfig.filter.enabled=e)),menu.image.addBool("histogram equalization",userConfig.filter,"equalization",(e=>userConfig.filter.equalization=e)),ui.menuWidth=menu.image.addRange("image width",userConfig.filter,"width",0,3840,10,(e=>userConfig.filter.width=parseInt(e))),ui.menuHeight=menu.image.addRange("image height",userConfig.filter,"height",0,2160,10,(e=>userConfig.filter.height=parseInt(e))),menu.image.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.image.addRange("brightness",userConfig.filter,"brightness",-1,1,.05,(e=>userConfig.filter.brightness=parseFloat(e))),menu.image.addRange("contrast",userConfig.filter,"contrast",-1,1,.05,(e=>userConfig.filter.contrast=parseFloat(e))),menu.image.addRange("sharpness",userConfig.filter,"sharpness",0,1,.05,(e=>userConfig.filter.sharpness=parseFloat(e))),menu.image.addRange("blur",userConfig.filter,"blur",0,20,1,(e=>userConfig.filter.blur=parseInt(e))),menu.image.addRange("saturation",userConfig.filter,"saturation",-1,1,.05,(e=>userConfig.filter.saturation=parseFloat(e))),menu.image.addRange("hue",userConfig.filter,"hue",0,360,5,(e=>userConfig.filter.hue=parseInt(e))),menu.image.addRange("pixelate",userConfig.filter,"pixelate",0,32,1,(e=>userConfig.filter.pixelate=parseInt(e))),menu.image.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.image.addBool("negative",userConfig.filter,"negative",(e=>userConfig.filter.negative=e)),menu.image.addBool("sepia",userConfig.filter,"sepia",(e=>userConfig.filter.sepia=e)),menu.image.addBool("vintage",userConfig.filter,"vintage",(e=>userConfig.filter.vintage=e)),menu.image.addBool("kodachrome",userConfig.filter,"kodachrome",(e=>userConfig.filter.kodachrome=e)),menu.image.addBool("technicolor",userConfig.filter,"technicolor",(e=>userConfig.filter.technicolor=e)),menu.image.addBool("polaroid",userConfig.filter,"polaroid",(e=>userConfig.filter.polaroid=e)),menu.image.addHTML('<label><input type="file" id="file-input" class="input-file"></input> &nbsp input</label>'),menu.image.addHTML('<label><input type="file" id="file-background" class="input-file"></input> &nbsp background</label>'),menu.process=new Menu(document.body,"",{top:t,left:e[2]}),menu.process.addList("backend",["cpu","webgl","wasm","humangl"],userConfig.backend,(e=>userConfig.backend=e)),menu.process.addBool("async operations",userConfig,"async",(e=>userConfig.async=e)),menu.process.addBool("use web worker",ui,"useWorker"),menu.process.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.process.addLabel("model parameters"),menu.process.addRange("max objects",userConfig.face.detector,"maxDetected",1,50,1,(e=>{userConfig.face.detector.maxDetected=parseInt(e),userConfig.body.maxDetected=parseInt(e),userConfig.hand.maxDetected=parseInt(e)})),menu.process.addRange("skip frames",userConfig.face.detector,"skipFrames",0,50,1,(e=>{userConfig.face.detector.skipFrames=parseInt(e),userConfig.face.emotion.skipFrames=parseInt(e),userConfig.hand.skipFrames=parseInt(e)})),menu.process.addRange("min confidence",userConfig.face.detector,"minConfidence",0,1,.05,(e=>{userConfig.face.detector.minConfidence=parseFloat(e),userConfig.face.emotion.minConfidence=parseFloat(e),userConfig.hand.minConfidence=parseFloat(e)})),menu.process.addRange("overlap",userConfig.face.detector,"iouThreshold",.1,1,.05,(e=>{userConfig.face.detector.iouThreshold=parseFloat(e),userConfig.hand.iouThreshold=parseFloat(e)})),menu.process.addBool("rotation detection",userConfig.face.detector,"rotation",(e=>{userConfig.face.detector.rotation=e,userConfig.hand.rotation=e})),menu.process.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.process.addChart("FPS","FPS"),menu.models=new Menu(document.body,"",{top:t,left:e[3]}),menu.models.addBool("face detect",userConfig.face,"enabled",(e=>userConfig.face.enabled=e)),menu.models.addBool("face mesh",userConfig.face.mesh,"enabled",(e=>userConfig.face.mesh.enabled=e)),menu.models.addBool("face iris",userConfig.face.iris,"enabled",(e=>userConfig.face.iris.enabled=e)),menu.models.addBool("face description",userConfig.face.description,"enabled",(e=>userConfig.face.description.enabled=e)),menu.models.addBool("face emotion",userConfig.face.emotion,"enabled",(e=>userConfig.face.emotion.enabled=e)),menu.models.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.models.addBool("body pose",userConfig.body,"enabled",(e=>userConfig.body.enabled=e)),menu.models.addBool("hand pose",userConfig.hand,"enabled",(e=>userConfig.hand.enabled=e)),menu.models.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.models.addBool("gestures",userConfig.gesture,"enabled",(e=>userConfig.gesture.enabled=e)),menu.models.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.models.addBool("body segmentation",userConfig.segmentation,"enabled",(e=>userConfig.segmentation.enabled=e)),menu.models.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.models.addBool("object detection",userConfig.object,"enabled",(e=>userConfig.object.enabled=e)),menu.models.addHTML('<hr style="border-style: dashed; border-color: white">'),menu.models.addBool("face compare",compare,"enabled",(e=>{compare.enabled=e,compare.original=null}));for(const e of Object.values(menu))e.hide();document.getElementById("btnDisplay").addEventListener("click",(e=>menu.display.toggle(e))),document.getElementById("btnImage").addEventListener("click",(e=>menu.image.toggle(e))),document.getElementById("btnProcess").addEventListener("click",(e=>menu.process.toggle(e))),document.getElementById("btnModel").addEventListener("click",(e=>menu.models.toggle(e))),document.getElementById("btnStart").addEventListener("click",(()=>detectVideo())),document.getElementById("play").addEventListener("click",(()=>detectVideo()))}async function resize(){window.onresize=null;if(!ui.viewportSet){document.querySelector("meta[name=viewport]").setAttribute("content","width=device-width, shrink-to-fit=yes, minimum-scale=0.2, maximum-scale=2.0, user-scalable=yes, initial-scale=0.7"),ui.viewportSet=!0}const e=[`${document.getElementById("btnDisplay").offsetLeft}px`,`${document.getElementById("btnImage").offsetLeft}px`,`${document.getElementById("btnProcess").offsetLeft}px`,`${document.getElementById("btnModel").offsetLeft}px`],t=document.getElementById("recis-bar").clientHeight-3+"px";menu.display.menu.style.top=t,menu.image.menu.style.top=t,menu.process.menu.style.top=t,menu.models.menu.style.top=t,menu.display.menu.style.left=e[0],menu.image.menu.style.left=e[1],menu.process.menu.style.left=e[2],menu.models.menu.style.left=e[3];const a=Math.trunc(10*(1-.7))+14;document.documentElement.style.fontSize=`${a}px`,human.draw.options.font=`small-caps ${a}px "Segoe UI"`,human.draw.options.lineHeight=a+2,await setupCamera(),window.onresize=resize}async function drawWarmup(e){const t=document.getElementById("canvas");t.width=e.canvas.width,t.height=e.canvas.height;t.getContext("2d").drawImage(e.canvas,0,0,e.canvas.width,e.canvas.height,0,0,t.width,t.height),await human.draw.all(t,e,drawOptions)}async function processDataURL(e,t){return new Promise((a=>{const n=new FileReader;n.onload=async n=>{if("process"===t&&(n.target.result.startsWith("data:image")&&await processImage(n.target.result,e.name),n.target.result.startsWith("data:video")&&await processVideo(n.target.result,e.name),document.getElementById("canvas").style.display="none"),"background"===t){const e=new Image;e.onerror=async()=>status("image loading error"),e.onload=async()=>{if(ui.background=e,"block"===document.getElementById("canvas").style.display){const e=document.getElementById("canvas"),t=e.getContext("2d"),a=await human.segmentation(e,ui.background,userConfig);a.canvas&&t.drawImage(a.canvas,0,0)}else{const e=document.getElementById("samples-container").children;for(const t of e){const e=t.getContext("2d"),a=await human.segmentation(t,ui.background,userConfig);a.canvas&&e.drawImage(a.canvas,0,0)}}},e.src=n.target.result}a(!0)},n.readAsDataURL(e)}))}async function runSegmentation(){document.getElementById("file-background").onchange=async e=>{userConfig.segmentation.enabled=!0,e.preventDefault(),e.target.files.length<2&&(ui.columns=1);for(const t of e.target.files)await processDataURL(t,"background")}}async function dragAndDrop(){document.body.addEventListener("dragenter",(e=>e.preventDefault())),document.body.addEventListener("dragleave",(e=>e.preventDefault())),document.body.addEventListener("dragover",(e=>e.preventDefault())),document.body.addEventListener("drop",(async e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy",e.dataTransfer.files.length<2&&(ui.columns=1);for(const t of e.dataTransfer.files)await processDataURL(t,"process")})),document.getElementById("file-input").onchange=async e=>{e.preventDefault(),e.target.files.length<2&&(ui.columns=1);for(const t of e.target.files)await processDataURL(t,"process")}}async function drawHints(){const e=document.getElementById("recis-hint");ui.hintsThread=setInterval((()=>{const t=Math.trunc(Math.random()*hints.length);e.innerText="hint: "+hints[t],e.style.opacity=1,setTimeout((()=>{e.style.opacity=0}),4500)}),5e3)}async function pwaRegister(){if(pwa.enabled)if("serviceWorker"in navigator){try{let e;const t=await navigator.serviceWorker.getRegistrations();for(const a of t)log("pwa found:",a.scope),a.scope.startsWith(location.origin)&&(e=a);if(!e){const t=await navigator.serviceWorker.register(pwa.scriptFile,{scope:location.pathname});e=t,log("pwa registered:",t.scope)}}catch(e){"SecurityError"===e.name?log("pwa: ssl certificate is untrusted"):log("pwa error:",e)}if(navigator.serviceWorker.controller){navigator.serviceWorker.controller.postMessage({key:"cacheModels",val:pwa.cacheModels}),navigator.serviceWorker.controller.postMessage({key:"cacheWASM",val:pwa.cacheWASM}),navigator.serviceWorker.controller.postMessage({key:"cacheOther",val:pwa.cacheOther}),log("pwa ctive:",navigator.serviceWorker.controller.scriptURL);const e=await caches.open(pwa.cacheName);if(e){log("pwa cache:",(await e.matchAll()).length,"files")}}}else log("pwa inactive")}async function main(){ui.exceptionHandler&&window.addEventListener("unhandledrejection",(e=>{ui.detectThread&&cancelAnimationFrame(ui.detectThread),ui.drawThread&&cancelAnimationFrame(ui.drawThread);const t=e.reason.message||e.reason||e;console.error(t),document.getElementById("recis-log").innerHTML=t,status(`exception: ${t}`),e.preventDefault()})),log("demo starting ..."),document.documentElement.style.setProperty("--icon-size",ui.iconSize),drawHints(),"undefined"!=typeof Worker&&"undefined"!=typeof OffscreenCanvas||(ui.useWorker=!1,log("webworker functionality is disabled due to missing browser functionality")),await pwaRegister();const e=new URLSearchParams(location.search);if(log("url options:",e.toString()),e.has("worker")&&(ui.useWorker=JSON.parse(e.get("worker")),log("overriding worker:",ui.useWorker)),e.has("backend")&&(userConfig.backend=e.get("backend"),log("overriding backend:",userConfig.backend)),e.has("preload")&&(ui.modelsPreload=JSON.parse(e.get("preload")),log("overriding preload:",ui.modelsPreload)),e.has("warmup")&&(ui.modelsWarmup=e.get("warmup"),log("overriding warmup:",ui.modelsWarmup)),e.has("bench")&&(ui.bench=JSON.parse(e.get("bench")),log("overriding bench:",ui.bench)),e.has("play")&&(ui.autoPlay=!0,log("overriding autoplay:",!0)),e.has("draw")&&(ui.drawWarmup=JSON.parse(e.get("draw")),log("overriding drawWarmup:",ui.drawWarmup)),e.has("async")&&(userConfig.async=JSON.parse(e.get("async")),log("overriding async:",userConfig.async)),human=new Human(userConfig),log("human version:",human.version),userConfig=human.config,"undefined"!=typeof tf&&(log("TensorFlow external version:",tf.version),human.tf=tf),log("tfjs version:",human.tf.version.tfjs),await setupMenu(),await resize(),document.getElementById("recis-log").innerText=`Human: version ${human.version}`,ui.modelsPreload&&!ui.useWorker){status("loading"),await human.load(userConfig);log("demo loaded models:",Object.keys(human.models).filter((e=>human.models[e])))}else await human.init();if(ui.modelsWarmup&&!ui.useWorker){status("initializing"),userConfig.warmup&&"none"!==userConfig.warmup||(userConfig.warmup="full");const e=await human.warmup(userConfig);e&&e.canvas&&ui.drawWarmup&&await drawWarmup(e)}if(status("Plant: ready"),document.getElementById("loader").style.display="none",document.getElementById("play").style.display="block",document.getElementById("results").style.display="none",await dragAndDrop(),await runSegmentation(),e.has("image")){try{const t=JSON.parse(e.get("image"));log("overriding image:",t),ui.samples=[t],ui.columns=1}catch{status("cannot parse input image"),log("cannot parse input image",e.get("image")),ui.samples=[]}ui.samples.length>0&&await detectSampleImages()}e.has("images")&&(log("overriding images list:",JSON.parse(e.get("images"))),await detectSampleImages()),human.config.debug&&log("environment:",human.env),"humangl"===human.config.backend&&human.config.debug&&log("backend:",human.gl)}window.onload=main;
